schema: '2.0'
stages:
  prepare_data:
    cmd: "python -m prepare_retrain_data  --data-dir ../inaturalist_12K  --max-drifted
      1000 --min-drifted 10 --batch-size 32  --generate-stats --save-datasets prepared_datasets.pkl\n"
    deps:
    - path: ../inaturalist_12K
      hash: md5
      md5: 73c3f58093e4de0df0d947996d6c7346.dir
      size: 3826132050
      nfiles: 12002
    - path: drift_check_report.json
      hash: md5
      md5: ca698e30e88fcf78b4df3b56c19d206b
      size: 101
    - path: prepare_retrain_data.py
      hash: md5
      md5: 980469018efcf114de57e5aece39e44b
      size: 13316
    params:
      params.yaml:
        batch_size: 32
        data_dir: ../inaturalist_12K
        max_drifted: 1000
        min_drifted: 10
    outs:
    - path: prepared_data_stats.json
      hash: md5
      md5: e5cb2a4f895d1e9fcbc30ab24999b641
      size: 175
    - path: prepared_datasets.pkl
      hash: md5
      md5: 1fcd6956c41bc5073d38b1707210de6d
      size: 13065467
  check_drift:
    cmd: "python drift_detection/check_drift_batch.py --models-dir drift_detection/drift_models\n"
    deps:
    - path: drift_detection/check_drift_batch.py
      hash: md5
      md5: c3f535518f1cd986d3b9c9698c8f16d9
      size: 10565
    - path: drift_detection/database.py
      hash: md5
      md5: 4a7c2fa6126a53325c91f43e6eb363a4
      size: 4315
    - path: drift_detection/drift_models/drift_detector.joblib
      hash: md5
      md5: f3e2153f28e58e18cae4ccd073c9c1c4
      size: 20386238
    - path: drift_detection/drift_models/feature_extractor.pth
      hash: md5
      md5: 78e2046244115b90eb8424bbc3426e32
      size: 94358538
    - path: drift_detection/load_drift_detector.py
      hash: md5
      md5: e792305410b566d7d4cde7ad18b6e640
      size: 2512
    outs:
    - path: drift_check_report.json
      hash: md5
      md5: ca698e30e88fcf78b4df3b56c19d206b
      size: 101
  train:
    cmd: "python -m retrain --load-datasets prepared_datasets.pkl --epochs 1 --learning-rate
      0.001 --freeze-strategy upto_stage_3 --dropout-rate 0.5 --experiment-name resnet_drift_retraining\n"
    deps:
    - path: prepared_data_stats.json
      hash: md5
      md5: e5cb2a4f895d1e9fcbc30ab24999b641
      size: 175
    - path: prepared_datasets.pkl
      hash: md5
      md5: 1fcd6956c41bc5073d38b1707210de6d
      size: 13065467
    - path: retrain.py
      hash: md5
      md5: ea1c4ee8a27084a616466d93a5b1cf2f
      size: 10360
    params:
      params.yaml:
        dropout_rate: 0.5
        epochs: 1
        freeze_strategy: upto_stage_3
        learning_rate: 0.001
        mlflow_experiment_name: resnet_drift_retraining
    outs:
    - path: models
      hash: md5
      md5: 953d97cfb83747dd7c6bc9609a0affbe.dir
      size: 492896370
      nfiles: 5
  evaluate:
    cmd: "python -m test_model --load-datasets prepared_datasets.pkl --num-classes
      10 --dropout-rate 0.5 --experiment-name resnet_drift_retraining_eval $([[ \"\
      true\" = \"true\" ]] && echo \"--update-db-status\" || echo \"\")\n"
    deps:
    - path: models
      hash: md5
      md5: 953d97cfb83747dd7c6bc9609a0affbe.dir
      size: 492896370
      nfiles: 5
    - path: test_model.py
      hash: md5
      md5: f8d31de8fd8c64fcd6815f0ef23e8f91
      size: 11544
    params:
      params.yaml:
        dropout_rate: 0.5
        mlflow_experiment_name: resnet_drift_retraining
        update_db_status: true
    outs:
    - path: test_results.json
      hash: md5
      md5: 2c6995d509faa55d0fc2e43d5d5e000d
      size: 4038
