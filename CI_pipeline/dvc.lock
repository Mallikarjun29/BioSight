schema: '2.0'
stages:
  prepare_data:
    cmd: "python -m prepare_retrain_data  --data-dir ../inaturalist_12K  --max-drifted
      1000 --min-drifted 10 --batch-size 32  --generate-stats --save-datasets prepared_datasets.pkl\n"
    deps:
    - path: ../inaturalist_12K
      hash: md5
      md5: 73c3f58093e4de0df0d947996d6c7346.dir
      size: 3826132050
      nfiles: 12002
    - path: drift_check_report.json
      hash: md5
      md5: ca1b5ebd99610992d96d105c028ed64c
      size: 103
    - path: prepare_retrain_data.py
      hash: md5
      md5: 6fc286f1909cb6b01f0064820c6dbc54
      size: 13314
    params:
      params.yaml:
        batch_size: 32
        data_dir: ../inaturalist_12K
        max_drifted: 1000
        min_drifted: 10
    outs:
    - path: prepared_data_stats.json
      hash: md5
      md5: 25c4c9747291b6631d683a210ad02cc1
      size: 174
    - path: prepared_datasets.pkl
      hash: md5
      md5: 1abb280781186a2a9d2268441225b3a8
      size: 2824139
  check_drift:
    cmd: "python ../drift_pipeline/check_drift_batch.py --models-dir ../drift_pipeline/drift_models\n"
    deps:
    - path: ../drift_pipeline/check_drift_batch.py
      hash: md5
      md5: 8a614b2e452f7ffa0dc9fd2108d88c2e
      size: 10558
    - path: ../drift_pipeline/database.py
      hash: md5
      md5: 4a7c2fa6126a53325c91f43e6eb363a4
      size: 4315
    - path: ../drift_pipeline/drift_models/drift_detector.joblib
      hash: md5
      md5: 1a44dd25176ae006cdb7f3f10e1bc69e
      size: 20386238
    - path: ../drift_pipeline/drift_models/feature_extractor.pth
      hash: md5
      md5: 78e2046244115b90eb8424bbc3426e32
      size: 94358538
    - path: ../drift_pipeline/load_drift_detector.py
      hash: md5
      md5: e792305410b566d7d4cde7ad18b6e640
      size: 2512
    outs:
    - path: drift_check_report.json
      hash: md5
      md5: ca1b5ebd99610992d96d105c028ed64c
      size: 103
  train:
    cmd: "python -m retrain --load-datasets prepared_datasets.pkl --epochs 1 --learning-rate
      0.001 --freeze-strategy upto_stage_3 --dropout-rate 0.5 --experiment-name resnet_drift_retraining\n"
    deps:
    - path: prepared_data_stats.json
      hash: md5
      md5: 25c4c9747291b6631d683a210ad02cc1
      size: 174
    - path: prepared_datasets.pkl
      hash: md5
      md5: 1abb280781186a2a9d2268441225b3a8
      size: 2824139
    - path: retrain.py
      hash: md5
      md5: 093d2c9c82efc39fcf5cd79d4e5d7c52
      size: 9549
    params:
      params.yaml:
        dropout_rate: 0.5
        epochs: 1
        freeze_strategy: upto_stage_3
        learning_rate: 0.001
        mlflow_experiment_name: resnet_drift_retraining
    outs:
    - path: best_model_resnet.pth
      hash: md5
      md5: 7220ce2ac4693e8b13bf9a34f3599c51
      size: 98573930
  evaluate:
    cmd: "python -m test_model --model-path best_model_resnet.pth --load-datasets
      prepared_datasets.pkl --num-classes 10 --dropout-rate 0.5 --experiment-name
      resnet_drift_retraining_eval $([[ \"true\" = \"true\" ]] && echo \"--update-db-status\"\
      \ || echo \"\")\n"
    deps:
    - path: best_model_resnet.pth
      hash: md5
      md5: 7220ce2ac4693e8b13bf9a34f3599c51
      size: 98573930
    - path: prepared_datasets.pkl
      hash: md5
      md5: 1abb280781186a2a9d2268441225b3a8
      size: 2824139
    - path: test_model.py
      hash: md5
      md5: 537797949362926f4e14f3bb1f0e8136
      size: 9896
    params:
      params.yaml:
        dropout_rate: 0.5
        mlflow_experiment_name: resnet_drift_retraining
        update_db_status: true
